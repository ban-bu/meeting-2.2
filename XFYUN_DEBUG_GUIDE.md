# 科大讯飞转录调试指南

## 问题描述

用户报告科大讯飞转录功能开始了，但没有输出任何转录内容，浏览器控制台显示：

```
流式转录已停止: {success: true}
xfyun-realtime-transcription.js:454 ✅ 使用AudioWorklet进行音频处理
xfyun-realtime-transcription.js:269 🎙️ 开始科大讯飞实时转录
```

## 已添加的调试功能

### 1. 客户端调试增强

#### 新增调试日志
- ✅ WebSocket连接状态详细日志
- ✅ 音频数据发送日志
- ✅ AudioWorklet音频处理日志
- ✅ 科大讯飞响应消息日志

#### 新增调试函数
```javascript
debugXfyunConnection()  // 全面的连接状态检查
```

### 2. 服务器端调试增强

#### 修复的问题
- ✅ 修复了`action: 'start'`时没有调用`connectToXfyun()`的问题
- ✅ 添加了音频数据转发的详细日志
- ✅ 添加了连接状态检查和警告

#### 新增调试日志
- ✅ 客户端请求日志
- ✅ 科大讯飞连接状态日志
- ✅ 音频帧转发日志

## 调试步骤

### 第一步: 检查客户端连接
在浏览器控制台运行：
```javascript
debugXfyunConnection()
```

**期望输出：**
```
🔧 科大讯飞连接调试信息:
- 录音状态: 录音中
- 连接状态: 已连接
- WebSocket状态: 打开
- 音频上下文: 已创建
- 媒体流: 已获取
- 音频处理器: 已创建
- 帧ID: [数字]
📤 发送测试消息...
```

### 第二步: 检查音频数据流
开始转录后，应该看到类似输出：
```
🎵 AudioWorklet收到音频数据，长度: 128
📤 发送音频帧 #0, 大小: 256 bytes
📤 发送音频帧 #1, 大小: 256 bytes
...
```

### 第三步: 检查服务器日志
服务器端应该显示：
```
📤 客户端请求开始转录
✅ 科大讯飞WebSocket连接成功
📤 转发音频帧到科大讯飞: #0, 状态: 0
📤 转发音频帧到科大讯飞: #1, 状态: 1
...
科大讯飞响应: [响应数据]
```

### 第四步: 检查科大讯飞响应
客户端应该收到：
```
📨 收到代理服务器消息: {"action":"result","data":{...}}
📝 收到转录结果: {...}
✅ 科大讯飞转录结果: [转录文本]
```

## 常见问题诊断

### 问题1: WebSocket连接失败
**症状**: `WebSocket状态: 关闭`

**解决方案**:
1. 检查服务器是否运行在正确端口
2. 检查Railway部署是否正常
3. 检查防火墙设置

### 问题2: 音频数据未发送
**症状**: 没有看到`📤 发送音频帧`日志

**解决方案**:
1. 检查麦克风权限
2. 检查AudioWorklet是否正常工作
3. 重新启动录音

### 问题3: 服务器未收到音频数据
**症状**: 服务器没有`📤 转发音频帧到科大讯飞`日志

**解决方案**:
1. 检查WebSocket代理路由
2. 检查消息格式
3. 重启服务器

### 问题4: 科大讯飞连接失败
**症状**: 服务器显示连接错误

**解决方案**:
1. 检查API Key和App ID
2. 检查网络连接
3. 检查科大讯飞服务状态

### 问题5: 收到连接但无转录结果
**症状**: 连接成功但没有转录文本

**解决方案**:
1. 检查音频格式是否正确
2. 检查科大讯飞响应格式解析
3. 增加音频音量
4. 检查语言设置

## 测试流程

### 完整测试步骤
1. **打开浏览器开发者工具**
2. **点击"科大讯飞转录"按钮**
3. **运行调试函数**: `debugXfyunConnection()`
4. **检查音频流**: 应该看到音频数据发送日志
5. **检查服务器日志**: 确认音频转发正常
6. **说话测试**: 清晰说话并检查转录结果
7. **停止转录**: 点击停止按钮

### 成功标准
- ✅ WebSocket连接建立
- ✅ 音频数据正常发送
- ✅ 服务器成功转发到科大讯飞
- ✅ 收到科大讯飞响应
- ✅ 转录文本正确显示

## 配置检查清单

### 客户端配置
- [x] AppID: `84959f16`
- [x] API Key: `065eee5163baa4692717b923323e6853`
- [x] WebSocket URL格式正确
- [x] 音频格式: PCM16, 16kHz, 单声道

### 服务器配置
- [x] express-ws已安装
- [x] WebSocket代理路由: `/xfyun-proxy`
- [x] 科大讯飞API配置正确
- [x] CORS设置允许WebSocket

### 网络配置
- [x] Railway WSS连接
- [x] 本地WS连接
- [x] 防火墙规则
- [x] 代理设置

## 下一步行动

1. **立即测试**: 使用`debugXfyunConnection()`函数
2. **查看日志**: 检查浏览器和服务器控制台
3. **逐步调试**: 按照调试步骤逐一检查
4. **报告结果**: 将调试输出发送给开发团队

---

**更新时间**: ${new Date().toLocaleString('zh-CN')}
**版本**: v1.0.0
**状态**: 🔍 调试工具已就绪