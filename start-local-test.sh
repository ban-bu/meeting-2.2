#!/bin/bash

echo "ğŸš€ å¯åŠ¨æœ¬åœ°æµ‹è¯•æœåŠ¡å™¨..."
echo "ğŸ“ è¯­éŸ³é€šè¯ä¿®å¤å·²åº”ç”¨ï¼š"
echo "   âœ… è¿æ¥è¶…æ—¶æ—¶é—´ä»30ç§’å‡å°‘åˆ°15ç§’"
echo "   âœ… Railwayç¯å¢ƒç›´æ¥ä½¿ç”¨WebSocketè¿æ¥"
echo "   âœ… é‡è¿å»¶è¿Ÿä»2ç§’å‡å°‘åˆ°1ç§’"
echo "   âœ… æ·»åŠ å¾®ä¿¡ç¾¤èŠå¼é€šè¯çŠ¶æ€æç¤º"
echo "   âœ… æ”¹è¿›æ¥ç”µæç¤ºæ¨¡æ€æ¡†æ˜¾ç¤º"
echo ""

# æ£€æŸ¥Node.jsæ˜¯å¦å®‰è£…
if ! command -v node &> /dev/null; then
    echo "âŒ Node.jsæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Node.js"
    exit 1
fi

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
if lsof -Pi :3001 -sTCP:LISTEN -t >/dev/null ; then
    echo "âš ï¸  ç«¯å£3001å·²è¢«å ç”¨ï¼Œæ­£åœ¨åœæ­¢ç°æœ‰è¿›ç¨‹..."
    pkill -f "node.*server.js"
    sleep 2
fi

# å¯åŠ¨æœåŠ¡å™¨
echo "ğŸ”§ å¯åŠ¨åç«¯æœåŠ¡å™¨..."
cd server
npm install
node server.js &
SERVER_PID=$!

echo "âœ… åç«¯æœåŠ¡å™¨å·²å¯åŠ¨ (PID: $SERVER_PID)"
echo "ğŸŒ æœåŠ¡å™¨åœ°å€: http://localhost:3001"

# ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
sleep 3

# å¯åŠ¨å‰ç«¯
echo "ğŸ¨ å¯åŠ¨å‰ç«¯æœåŠ¡å™¨..."
cd ..
python3 -m http.server 8080 &
FRONTEND_PID=$!

echo "âœ… å‰ç«¯æœåŠ¡å™¨å·²å¯åŠ¨ (PID: $FRONTEND_PID)"
echo "ğŸŒ å‰ç«¯åœ°å€: http://localhost:8080"

echo ""
echo "ğŸ“‹ æµ‹è¯•æ­¥éª¤ï¼š"
echo "1. æ‰“å¼€æµè§ˆå™¨è®¿é—® http://localhost:8080"
echo "2. è®¾ç½®ç”¨æˆ·åå¹¶åŠ å…¥æˆ¿é—´"
echo "3. åœ¨å¦ä¸€ä¸ªæµè§ˆå™¨çª—å£æ‰“å¼€ç›¸åŒåœ°å€ï¼Œä½¿ç”¨ä¸åŒç”¨æˆ·å"
echo "4. æµ‹è¯•è¯­éŸ³é€šè¯åŠŸèƒ½ï¼š"
echo "   - ç‚¹å‡»é€šè¯æŒ‰é’®å‘èµ·é€šè¯"
echo "   - æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºå¾®ä¿¡ç¾¤èŠå¼é€šè¯æç¤º"
echo "   - æµ‹è¯•æ¥ç”µæç¤ºæ¨¡æ€æ¡†"
echo "   - æµ‹è¯•æ¥å¬/æ‹’ç»åŠŸèƒ½"
echo "5. æ£€æŸ¥è¿æ¥é€Ÿåº¦æ˜¯å¦æ”¹å–„"
echo ""
echo "ğŸ”§ è°ƒè¯•å·¥å…·ï¼š"
echo "- æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¿æ¥çŠ¶æ€"
echo "- æ£€æŸ¥ç½‘ç»œé¢æ¿ä¸­çš„WebSocketè¿æ¥"
echo ""

# ç­‰å¾…ç”¨æˆ·ä¸­æ–­
echo "æŒ‰ Ctrl+C åœæ­¢æœåŠ¡å™¨"
trap "echo 'ğŸ›‘ æ­£åœ¨åœæ­¢æœåŠ¡å™¨...'; kill $SERVER_PID $FRONTEND_PID 2>/dev/null; exit" INT

# ä¿æŒè„šæœ¬è¿è¡Œ
wait 